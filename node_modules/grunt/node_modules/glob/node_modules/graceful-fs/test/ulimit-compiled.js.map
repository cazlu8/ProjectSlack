{"version":3,"sources":["ulimit.js"],"names":[],"mappings":"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","file":"ulimit-compiled.js","sourcesContent":["var test = require('tap').test\n\n// simulated ulimit\n// this is like graceful-fs, but in reverse\nvar fs_ = require('fs')\nvar fs = require('../graceful-fs.js')\nvar files = fs.readdirSync(__dirname)\n\n// Ok, no more actual file reading!\n\nvar fds = 0\nvar nextFd = 60\nvar limit = 8\nfs_.open = function (path, flags, mode, cb) {\n  process.nextTick(function() {\n    ++fds\n    if (fds >= limit) {\n      --fds\n      var er = new Error('EMFILE Curses!')\n      er.code = 'EMFILE'\n      er.path = path\n      return cb(er)\n    } else {\n      cb(null, nextFd++)\n    }\n  })\n}\n\nfs_.openSync = function (path, flags, mode) {\n  if (fds >= limit) {\n    var er = new Error('EMFILE Curses!')\n    er.code = 'EMFILE'\n    er.path = path\n    throw er\n  } else {\n    ++fds\n    return nextFd++\n  }\n}\n\nfs_.close = function (fd, cb) {\n  process.nextTick(function () {\n    --fds\n    cb()\n  })\n}\n\nfs_.closeSync = function (fd) {\n  --fds\n}\n\nfs_.readdir = function (path, cb) {\n  process.nextTick(function() {\n    if (fds >= limit) {\n      var er = new Error('EMFILE Curses!')\n      er.code = 'EMFILE'\n      er.path = path\n      return cb(er)\n    } else {\n      ++fds\n      process.nextTick(function () {\n        --fds\n        cb(null, [__filename, \"some-other-file.js\"])\n      })\n    }\n  })\n}\n\nfs_.readdirSync = function (path) {\n  if (fds >= limit) {\n    var er = new Error('EMFILE Curses!')\n    er.code = 'EMFILE'\n    er.path = path\n    throw er\n  } else {\n    return [__filename, \"some-other-file.js\"]\n  }\n}\n\n\ntest('open emfile autoreduce', function (t) {\n  fs.MIN_MAX_OPEN = 4\n  t.equal(fs.MAX_OPEN, 1024)\n\n  var max = 12\n  for (var i = 0; i < max; i++) {\n    fs.open(__filename, 'r', next(i))\n  }\n\n  var phase = 0\n\n  var expect =\n      [ [ 0, 60, null, 1024, 4, 12, 1 ],\n        [ 1, 61, null, 1024, 4, 12, 2 ],\n        [ 2, 62, null, 1024, 4, 12, 3 ],\n        [ 3, 63, null, 1024, 4, 12, 4 ],\n        [ 4, 64, null, 1024, 4, 12, 5 ],\n        [ 5, 65, null, 1024, 4, 12, 6 ],\n        [ 6, 66, null, 1024, 4, 12, 7 ],\n        [ 7, 67, null, 6, 4, 5, 1 ],\n        [ 8, 68, null, 6, 4, 5, 2 ],\n        [ 9, 69, null, 6, 4, 5, 3 ],\n        [ 10, 70, null, 6, 4, 5, 4 ],\n        [ 11, 71, null, 6, 4, 5, 5 ] ]\n\n  var actual = []\n\n  function next (i) { return function (er, fd) {\n    if (er)\n      throw er\n    actual.push([i, fd, er, fs.MAX_OPEN, fs.MIN_MAX_OPEN, fs._curOpen, fds])\n\n    if (i === max - 1) {\n      t.same(actual, expect)\n      t.ok(fs.MAX_OPEN < limit)\n      t.end()\n    }\n\n    fs.close(fd)\n  } }\n})\n\ntest('readdir emfile autoreduce', function (t) {\n  fs.MAX_OPEN = 1024\n  var max = 12\n  for (var i = 0; i < max; i ++) {\n    fs.readdir(__dirname, next(i))\n  }\n\n  var expect =\n      [ [0,[__filename,\"some-other-file.js\"],null,7,4,7,7],\n        [1,[__filename,\"some-other-file.js\"],null,7,4,7,6],\n        [2,[__filename,\"some-other-file.js\"],null,7,4,7,5],\n        [3,[__filename,\"some-other-file.js\"],null,7,4,7,4],\n        [4,[__filename,\"some-other-file.js\"],null,7,4,7,3],\n        [5,[__filename,\"some-other-file.js\"],null,7,4,6,2],\n        [6,[__filename,\"some-other-file.js\"],null,7,4,5,1],\n        [7,[__filename,\"some-other-file.js\"],null,7,4,4,0],\n        [8,[__filename,\"some-other-file.js\"],null,7,4,3,3],\n        [9,[__filename,\"some-other-file.js\"],null,7,4,2,2],\n        [10,[__filename,\"some-other-file.js\"],null,7,4,1,1],\n        [11,[__filename,\"some-other-file.js\"],null,7,4,0,0] ]\n\n  var actual = []\n\n  function next (i) { return function (er, files) {\n    if (er)\n      throw er\n    var line = [i, files, er, fs.MAX_OPEN, fs.MIN_MAX_OPEN, fs._curOpen, fds ]\n    actual.push(line)\n\n    if (i === max - 1) {\n      t.ok(fs.MAX_OPEN < limit)\n      t.same(actual, expect)\n      t.end()\n    }\n  } }\n})\n"]}