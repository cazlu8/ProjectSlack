{"version":3,"sources":["add-local.js"],"names":[],"mappings":"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","file":"add-local-compiled.js","sourcesContent":["var assert = require(\"assert\")\n  , path = require(\"path\")\n  , mkdir = require(\"mkdirp\")\n  , chownr = require(\"chownr\")\n  , pathIsInside = require(\"path-is-inside\")\n  , readJson = require(\"read-package-json\")\n  , log = require(\"npmlog\")\n  , npm = require(\"../npm.js\")\n  , tar = require(\"../utils/tar.js\")\n  , deprCheck = require(\"../utils/depr-check.js\")\n  , getCacheStat = require(\"./get-stat.js\")\n  , cachedPackageRoot = require(\"./cached-package-root.js\")\n  , addLocalTarball = require(\"./add-local-tarball.js\")\n  , sha = require(\"sha\")\n  , inflight = require(\"inflight\")\n\nmodule.exports = addLocal\n\nfunction addLocal (p, pkgData, cb_) {\n  assert(typeof p === \"object\", \"must have spec info\")\n  assert(typeof cb === \"function\", \"must have callback\")\n\n  pkgData = pkgData || {}\n\n  function cb (er, data) {\n    if (er) {\n      log.error(\"addLocal\", \"Could not install %s\", p.spec)\n      return cb_(er)\n    }\n    if (data && !data._fromGithub) {\n      data._from = path.relative(npm.prefix, p.spec) || \".\"\n      var resolved = path.relative(npm.prefix, p.spec)\n      if (resolved) data._resolved = \"file:\"+resolved\n    }\n    return cb_(er, data)\n  }\n\n  if (p.type === \"directory\") {\n    addLocalDirectory(p.spec, pkgData, null, cb)\n  }\n  else {\n    addLocalTarball(p.spec, pkgData, null, cb)\n  }\n}\n\n// At this point, if shasum is set, it's something that we've already\n// read and checked.  Just stashing it in the data at this point.\nfunction addLocalDirectory (p, pkgData, shasum, cb) {\n  assert(pkgData, \"must pass package data\")\n  assert(typeof cb === \"function\", \"must have callback\")\n\n  // if it's a folder, then read the package.json,\n  // tar it to the proper place, and add the cache tar\n  if (pathIsInside(p, npm.cache)) return cb(new Error(\n    \"Adding a cache directory to the cache will make the world implode.\"))\n\n  readJson(path.join(p, \"package.json\"), false, function (er, data) {\n    if (er) return cb(er)\n\n    if (!data.name) {\n      return cb(new Error(\"No name provided in package.json\"))\n    }\n    else if (pkgData.name && pkgData.name !== data.name) {\n      return cb(new Error(\n        \"Invalid package: expected \" + pkgData.name + \" but found \" + data.name\n      ))\n    }\n\n    if (!data.version) {\n      return cb(new Error(\"No version provided in package.json\"))\n    }\n    else if (pkgData.version && pkgData.version !== data.version) {\n      return cb(new Error(\n        \"Invalid package: expected \" + pkgData.name + \"@\" + pkgData.version +\n          \" but found \" + data.name + \"@\" + data.version\n      ))\n    }\n\n    deprCheck(data)\n\n    // pack to {cache}/name/ver/package.tgz\n    var root = cachedPackageRoot(data)\n    var tgz = path.resolve(root, \"package.tgz\")\n    var pj = path.resolve(root, \"package/package.json\")\n\n    var wrapped = inflight(tgz, next)\n    if (!wrapped) return log.verbose(\"addLocalDirectory\", tgz, \"already in flight; waiting\")\n    log.verbose(\"addLocalDirectory\", tgz, \"not in flight; packing\")\n\n    getCacheStat(function (er, cs) {\n      mkdir(path.dirname(pj), function (er, made) {\n        if (er) return cb(er)\n        var fancy = !pathIsInside(p, npm.tmp)\n        tar.pack(tgz, p, data, fancy, function (er) {\n          if (er) {\n            log.error(\"addLocalDirectory\", \"Could not pack\", p, \"to\", tgz)\n            return cb(er)\n          }\n\n          if (!cs || isNaN(cs.uid) || isNaN(cs.gid)) wrapped()\n\n          chownr(made || tgz, cs.uid, cs.gid, wrapped)\n        })\n      })\n    })\n\n    function next (er) {\n      if (er) return cb(er)\n      // if we have the shasum already, just add it\n      if (shasum) {\n        return addLocalTarball(tgz, data, shasum, cb)\n      } else {\n        sha.get(tgz, function (er, shasum) {\n          if (er) {\n            return cb(er)\n          }\n          data._shasum = shasum\n          return addLocalTarball(tgz, data, shasum, cb)\n        })\n      }\n    }\n  })\n}\n"]}