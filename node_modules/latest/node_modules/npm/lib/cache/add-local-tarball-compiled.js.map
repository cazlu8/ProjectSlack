{"version":3,"sources":["add-local-tarball.js"],"names":[],"mappings":"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","file":"add-local-tarball-compiled.js","sourcesContent":["var mkdir = require(\"mkdirp\")\n  , assert = require(\"assert\")\n  , fs = require(\"graceful-fs\")\n  , writeFileAtomic = require(\"write-file-atomic\")\n  , path = require(\"path\")\n  , sha = require(\"sha\")\n  , npm = require(\"../npm.js\")\n  , log = require(\"npmlog\")\n  , tar = require(\"../utils/tar.js\")\n  , pathIsInside = require(\"path-is-inside\")\n  , getCacheStat = require(\"./get-stat.js\")\n  , cachedPackageRoot = require(\"./cached-package-root.js\")\n  , chownr = require(\"chownr\")\n  , inflight = require(\"inflight\")\n  , once = require(\"once\")\n  , writeStream = require(\"fs-write-stream-atomic\")\n  , randomBytes = require(\"crypto\").pseudoRandomBytes // only need uniqueness\n\nmodule.exports = addLocalTarball\n\nfunction addLocalTarball (p, pkgData, shasum, cb) {\n  assert(typeof p === \"string\", \"must have path\")\n  assert(typeof cb === \"function\", \"must have callback\")\n\n  if (!pkgData) pkgData = {}\n\n  // If we don't have a shasum yet, compute it.\n  if (!shasum) {\n    return sha.get(p, function (er, shasum) {\n      if (er) return cb(er)\n      log.silly(\"addLocalTarball\", \"shasum (computed)\", shasum)\n      addLocalTarball(p, pkgData, shasum, cb)\n    })\n  }\n\n  if (pathIsInside(p, npm.cache)) {\n    if (path.basename(p) !== \"package.tgz\") {\n      return cb(new Error(\"Not a valid cache tarball name: \"+p))\n    }\n    log.verbose(\"addLocalTarball\", \"adding from inside cache\", p)\n    return addPlacedTarball(p, pkgData, shasum, cb)\n  }\n\n  addTmpTarball(p, pkgData, shasum, function (er, data) {\n    if (data) {\n      data._resolved = p\n      data._shasum = data._shasum || shasum\n    }\n    return cb(er, data)\n  })\n}\n\nfunction addPlacedTarball (p, pkgData, shasum, cb) {\n  assert(pkgData, \"should have package data by now\")\n  assert(typeof cb === \"function\", \"cb function required\")\n\n  getCacheStat(function (er, cs) {\n    if (er) return cb(er)\n    return addPlacedTarball_(p, pkgData, cs.uid, cs.gid, shasum, cb)\n  })\n}\n\nfunction addPlacedTarball_ (p, pkgData, uid, gid, resolvedSum, cb) {\n  var folder = path.join(cachedPackageRoot(pkgData), \"package\")\n\n  // First, make sure we have the shasum, if we don't already.\n  if (!resolvedSum) {\n    sha.get(p, function (er, shasum) {\n      if (er) return cb(er)\n      addPlacedTarball_(p, pkgData, uid, gid, shasum, cb)\n    })\n    return\n  }\n\n  mkdir(folder, function (er) {\n    if (er) return cb(er)\n    var pj = path.join(folder, \"package.json\")\n    var json = JSON.stringify(pkgData, null, 2)\n    writeFileAtomic(pj, json, function (er) {\n      cb(er, pkgData)\n    })\n  })\n}\n\nfunction addTmpTarball (tgz, pkgData, shasum, cb) {\n  assert(typeof cb === \"function\", \"must have callback function\")\n  assert(shasum, \"must have shasum by now\")\n\n  cb = inflight(\"addTmpTarball:\" + tgz, cb)\n  if (!cb) return log.verbose(\"addTmpTarball\", tgz, \"already in flight; not adding\")\n  log.verbose(\"addTmpTarball\", tgz, \"not in flight; adding\")\n\n  // we already have the package info, so just move into place\n  if (pkgData && pkgData.name && pkgData.version) {\n    log.verbose(\n      \"addTmpTarball\",\n      \"already have metadata; skipping unpack for\",\n      pkgData.name + \"@\" + pkgData.version\n    )\n    return addTmpTarball_(tgz, pkgData, shasum, cb)\n  }\n\n  // This is a tarball we probably downloaded from the internet.  The shasum's\n  // already been checked, but we haven't ever had a peek inside, so we unpack\n  // it here just to make sure it is what it says it is.\n  //\n  // NOTE: we might not have any clue what we think it is, for example if the\n  // user just did `npm install ./foo.tgz`\n\n  // generate a unique filename\n  randomBytes(6, function (er, random) {\n    if (er) return cb(er)\n\n    var target = path.join(npm.tmp, \"unpack-\" + random.toString(\"hex\"))\n    getCacheStat(function (er, cs) {\n      if (er) return cb(er)\n\n      log.verbose(\"addTmpTarball\", \"validating metadata from\", tgz)\n      tar.unpack(tgz, target, null, null, cs.uid, cs.gid, function (er, data) {\n        if (er) return cb(er)\n\n        // check that this is what we expected.\n        if (!data.name) {\n          return cb(new Error(\"No name provided\"))\n        }\n        else if (pkgData.name && data.name !== pkgData.name) {\n          return cb(new Error(\"Invalid Package: expected \" + pkgData.name +\n                              \" but found \" + data.name))\n        }\n\n        if (!data.version) {\n          return cb(new Error(\"No version provided\"))\n        }\n        else if (pkgData.version && data.version !== pkgData.version) {\n          return cb(new Error(\"Invalid Package: expected \" +\n                              pkgData.name + \"@\" + pkgData.version +\n                              \" but found \" + data.name + \"@\" + data.version))\n        }\n\n        addTmpTarball_(tgz, data, shasum, cb)\n      })\n    })\n  })\n}\n\nfunction addTmpTarball_ (tgz, data, shasum, cb) {\n  assert(typeof cb === \"function\", \"must have callback function\")\n  cb = once(cb)\n\n  assert(data.name, \"should have package name by now\")\n  assert(data.version, \"should have package version by now\")\n\n  var root = cachedPackageRoot(data)\n  var pkg = path.resolve(root, \"package\")\n  var target = path.resolve(root, \"package.tgz\")\n  getCacheStat(function (er, cs) {\n    if (er) return cb(er)\n    mkdir(pkg, function (er, created) {\n\n      // chown starting from the first dir created by mkdirp,\n      // or the root dir, if none had to be created, so that\n      // we know that we get all the children.\n      function chown () {\n        chownr(created || root, cs.uid, cs.gid, done)\n      }\n\n      if (er) return cb(er)\n      var read = fs.createReadStream(tgz)\n      var write = writeStream(target, { mode: npm.modes.file })\n      var fin = cs.uid && cs.gid ? chown : done\n      read.on(\"error\", cb).pipe(write).on(\"error\", cb).on(\"close\", fin)\n    })\n\n  })\n\n  function done() {\n    data._shasum = data._shasum || shasum\n    cb(null, data)\n  }\n}\n"]}