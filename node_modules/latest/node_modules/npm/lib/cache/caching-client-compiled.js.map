{"version":3,"sources":["caching-client.js"],"names":[],"mappings":"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","file":"caching-client-compiled.js","sourcesContent":["module.exports = CachingRegistryClient\n\nvar path = require(\"path\")\n  , fs = require(\"graceful-fs\")\n  , url = require(\"url\")\n  , assert = require(\"assert\")\n  , inherits = require(\"util\").inherits\n\nvar RegistryClient = require(\"npm-registry-client\")\n  , npm = require(\"../npm.js\")\n  , log = require(\"npmlog\")\n  , getCacheStat = require(\"./get-stat.js\")\n  , cacheFile = require(\"npm-cache-filename\")\n  , mkdirp = require(\"mkdirp\")\n  , rimraf = require(\"rimraf\")\n  , chownr = require(\"chownr\")\n  , writeFile = require(\"write-file-atomic\")\n\nfunction CachingRegistryClient (config) {\n  RegistryClient.call(this, adaptConfig(config))\n\n  this._mapToCache = cacheFile(config.get(\"cache\"))\n\n  // swizzle in our custom cache invalidation logic\n  this._request = this.request\n  this.request  = this._invalidatingRequest\n  this.get      = get\n}\ninherits(CachingRegistryClient, RegistryClient)\n\nCachingRegistryClient.prototype._invalidatingRequest = function (uri, params, cb) {\n  var client = this\n  this._request.call(this, uri, params, function () {\n    var args = arguments\n\n    var method = params.method\n    if (method !== \"HEAD\" && method !== \"GET\") {\n      var invalidated = client._mapToCache(uri)\n      // invalidate cache\n      //\n      // This is irrelevant for commands that do etag / last-modified caching,\n      // but ls and view also have a timed cache, so this keeps the user from\n      // thinking that it didn't work when it did.\n      // Note that failure is an acceptable option here, since the only\n      // result will be a stale cache for some helper commands.\n      log.verbose(\"request\", \"invalidating\", invalidated, \"on\", method)\n      return rimraf(invalidated, function () {\n        cb.apply(undefined, args)\n      })\n    }\n\n    cb.apply(undefined, args)\n  })\n}\n\nfunction get (uri, params, cb) {\n  assert(typeof uri === \"string\", \"must pass registry URI to get\")\n  assert(params && typeof params === \"object\", \"must pass params to get\")\n  assert(typeof cb === \"function\", \"must pass callback to get\")\n\n  var parsed = url.parse(uri)\n  assert(\n    parsed.protocol === \"http:\" || parsed.protocol === \"https:\",\n    \"must have a URL that starts with http: or https:\"\n  )\n\n  var cacheBase = cacheFile(npm.config.get(\"cache\"))(uri)\n  var cachePath = path.join(cacheBase, \".cache.json\")\n\n  // If the GET is part of a write operation (PUT or DELETE), then\n  // skip past the cache entirely, but still save the results.\n  if (uri.match(/\\?write=true$/)) {\n    log.verbose(\"get\", \"GET as part of write; not caching result\")\n    return get_.call(this, uri, cachePath, params, cb)\n  }\n\n  var client = this\n  fs.stat(cachePath, function (er, stat) {\n    if (!er) {\n      fs.readFile(cachePath, function (er, data) {\n        try {\n          data = JSON.parse(data)\n        }\n        catch (ex) {\n          data = null\n        }\n\n        params.stat = stat\n        params.data = data\n\n        get_.call(client, uri, cachePath, params, cb)\n      })\n    }\n    else {\n      get_.call(client, uri, cachePath, params, cb)\n    }\n  })\n}\n\nfunction get_ (uri, cachePath, params, cb) {\n  var staleOk = params.staleOk === undefined ? false : params.staleOk\n    , timeout = params.timeout === undefined ? -1 : params.timeout\n    , data    = params.data\n    , stat    = params.stat\n    , etag\n    , lastModified\n\n  timeout = Math.min(timeout, npm.config.get(\"cache-max\") || 0)\n  timeout = Math.max(timeout, npm.config.get(\"cache-min\") || -Infinity)\n  if (process.env.COMP_CWORD !== undefined &&\n      process.env.COMP_LINE  !== undefined &&\n      process.env.COMP_POINT !== undefined) {\n    timeout = Math.max(timeout, 60000)\n  }\n\n  if (data) {\n    if (data._etag) etag = data._etag\n    if (data._lastModified) lastModified = data._lastModified\n\n    if (stat && timeout && timeout > 0) {\n      if ((Date.now() - stat.mtime.getTime())/1000 < timeout) {\n        log.verbose(\"get\", uri, \"not expired, no request\")\n        delete data._etag\n        delete data._lastModified\n        return cb(null, data, JSON.stringify(data), { statusCode : 304 })\n      }\n\n      if (staleOk) {\n        log.verbose(\"get\", uri, \"staleOk, background update\")\n        delete data._etag\n        delete data._lastModified\n        process.nextTick(\n          cb.bind(null, null, data, JSON.stringify(data), { statusCode : 304 } )\n        )\n        cb = function () {}\n      }\n    }\n  }\n\n  var options = {\n    etag         : etag,\n    lastModified : lastModified,\n    follow       : params.follow,\n    auth         : params.auth\n  }\n  this.request(uri, options, function (er, remoteData, raw, response) {\n    // if we get an error talking to the registry, but we have it\n    // from the cache, then just pretend we got it.\n    if (er && cachePath && data && !data.error) {\n      er = null\n      response = { statusCode: 304 }\n    }\n\n    if (response) {\n      log.silly(\"get\", \"cb\", [response.statusCode, response.headers])\n      if (response.statusCode === 304 && (etag || lastModified)) {\n        remoteData = data\n        log.verbose(etag ? \"etag\" : \"lastModified\", uri+\" from cache\")\n      }\n    }\n\n    data = remoteData\n    if (!data) er = er || new Error(\"failed to fetch from registry: \" + uri)\n\n    if (er) return cb(er, data, raw, response)\n\n    saveToCache(cachePath, data, saved)\n\n    // just give the write the old college try.  if it fails, whatever.\n    function saved () {\n      delete data._etag\n      delete data._lastModified\n      cb(er, data, raw, response)\n    }\n\n    function saveToCache (cachePath, data, saved) {\n      log.verbose(\"get\", \"saving\", data.name, \"to\", cachePath)\n      getCacheStat(function (er, st) {\n        mkdirp(path.dirname(cachePath), function (er, made) {\n          if (er) return saved()\n\n          writeFile(cachePath, JSON.stringify(data), function (er) {\n            if (er) return saved()\n\n            chownr(made || cachePath, st.uid, st.gid, saved)\n          })\n        })\n      })\n    }\n  })\n}\n\nfunction adaptConfig (config) {\n  return {\n    proxy : {\n      http         : config.get(\"proxy\"),\n      https        : config.get(\"https-proxy\"),\n      localAddress : config.get(\"local-address\")\n    },\n    ssl : {\n      certificate : config.get(\"cert\"),\n      key         : config.get(\"key\"),\n      ca          : config.get(\"ca\"),\n      strict      : config.get(\"strict-ssl\")\n    },\n    retry : {\n      retries    : config.get(\"fetch-retries\"),\n      factor     : config.get(\"fetch-retry-factor\"),\n      minTimeout : config.get(\"fetch-retry-mintimeout\"),\n      maxTimeout : config.get(\"fetch-retry-maxtimeout\")\n    },\n    userAgent  : config.get(\"user-agent\"),\n    log        : log,\n    defaultTag : config.get(\"tag\"),\n    couchToken : config.get(\"_token\")\n  }\n}\n"]}