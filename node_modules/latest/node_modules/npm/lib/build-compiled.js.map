{"version":3,"sources":["build.js"],"names":[],"mappings":"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","file":"build-compiled.js","sourcesContent":["// npm build command\n\n// everything about the installation after the creation of\n// the .npm/{name}/{version}/package folder.\n// linking the modules into the npm.root,\n// resolving dependencies, etc.\n\n// This runs AFTER install or link are completed.\n\nvar npm = require(\"./npm.js\")\n  , log = require(\"npmlog\")\n  , chain = require(\"slide\").chain\n  , fs = require(\"graceful-fs\")\n  , path = require(\"path\")\n  , lifecycle = require(\"./utils/lifecycle.js\")\n  , readJson = require(\"read-package-json\")\n  , link = require(\"./utils/link.js\")\n  , linkIfExists = link.ifExists\n  , cmdShim = require(\"cmd-shim\")\n  , cmdShimIfExists = cmdShim.ifExists\n  , asyncMap = require(\"slide\").asyncMap\n  , ini = require(\"ini\")\n  , writeFile = require(\"write-file-atomic\")\n\nmodule.exports = build\nbuild.usage = \"npm build <folder>\\n(this is plumbing)\"\n\nbuild._didBuild = {}\nbuild._noLC = {}\nfunction build (args, global, didPre, didRB, cb) {\n  if (typeof cb !== \"function\") cb = didRB, didRB = false\n  if (typeof cb !== \"function\") cb = didPre, didPre = false\n  if (typeof cb !== \"function\") {\n    cb = global, global = npm.config.get(\"global\")\n  }\n  // it'd be nice to asyncMap these, but actually, doing them\n  // in parallel generally munges up the output from node-waf\n  var builder = build_(global, didPre, didRB)\n  chain(args.map(function (arg) { return function (cb) {\n    builder(arg, cb)\n  }}), cb)\n}\n\nfunction build_ (global, didPre, didRB) { return function (folder, cb) {\n  folder = path.resolve(folder)\n  if (build._didBuild[folder]) log.info(\"build\", \"already built\", folder)\n  build._didBuild[folder] = true\n  log.info(\"build\", folder)\n  readJson(path.resolve(folder, \"package.json\"), function (er, pkg) {\n    if (er) return cb(er)\n    chain\n      ( [ !didPre && [lifecycle, pkg, \"preinstall\", folder]\n        , [linkStuff, pkg, folder, global, didRB]\n        , [writeBuiltinConf, pkg, folder]\n        , didPre !== build._noLC && [lifecycle, pkg, \"install\", folder]\n        , didPre !== build._noLC && [lifecycle, pkg, \"postinstall\", folder]\n        , didPre !== build._noLC\n          && npm.config.get(\"npat\")\n          && [lifecycle, pkg, \"test\", folder] ]\n      , cb )\n  })\n}}\n\nfunction writeBuiltinConf (pkg, folder, cb) {\n  // the builtin config is \"sticky\". Any time npm installs\n  // itself globally, it puts its builtin config file there\n  var parent = path.dirname(folder)\n  var dir = npm.globalDir\n\n  if (pkg.name !== \"npm\" ||\n      !npm.config.get(\"global\") ||\n      !npm.config.usingBuiltin ||\n      dir !== parent) {\n    return cb()\n  }\n\n  var data = ini.stringify(npm.config.sources.builtin.data)\n  writeFile(path.resolve(folder, \"npmrc\"), data, cb)\n}\n\nfunction linkStuff (pkg, folder, global, didRB, cb) {\n  // allow to opt out of linking binaries.\n  if (npm.config.get(\"bin-links\") === false) return cb()\n\n  // if it's global, and folder is in {prefix}/node_modules,\n  // then bins are in {prefix}/bin\n  // otherwise, then bins are in folder/../.bin\n  var parent = pkg.name[0] === '@' ? path.dirname(path.dirname(folder)) : path.dirname(folder)\n  var gnm = global && npm.globalDir\n  var gtop = parent === gnm\n\n  log.info('linkStuff', pkg._id)\n  log.silly('linkStuff', pkg._id, 'has', parent, 'as its parent node_modules')\n  if (global) log.silly('linkStuff', pkg._id, 'is part of a global install')\n  if (gnm) log.silly('linkStuff', pkg._id, 'is installed into a global node_modules')\n  if (gtop) log.silly('linkStuff', pkg._id, 'is installed into the top-level global node_modules')\n\n  shouldWarn(pkg, folder, global, function () {\n    asyncMap(\n      [linkBins, linkMans, !didRB && rebuildBundles],\n      function (fn, cb) {\n        if (!fn) return cb()\n        log.verbose(fn.name, pkg._id)\n        fn(pkg, folder, parent, gtop, cb)\n      },\n      cb\n    )\n  })\n}\n\nfunction shouldWarn(pkg, folder, global, cb) {\n  var parent = path.dirname(folder)\n    , top = parent === npm.dir\n    , cwd = npm.localPrefix\n\n  readJson(path.resolve(cwd, \"package.json\"), function(er, topPkg) {\n    if (er) return cb(er)\n\n    var linkedPkg = path.basename(cwd)\n      , currentPkg = path.basename(folder)\n\n    // current searched package is the linked package on first call\n    if (linkedPkg !== currentPkg) {\n\n      if (!topPkg.dependencies) return cb()\n\n      // don't generate a warning if it's listed in dependencies\n      if (Object.keys(topPkg.dependencies).indexOf(currentPkg) === -1) {\n\n        if (top && pkg.preferGlobal && !global) {\n          log.warn(\"prefer global\", pkg._id + \" should be installed with -g\")\n        }\n      }\n    }\n\n    cb()\n  })\n}\n\nfunction rebuildBundles (pkg, folder, parent, gtop, cb) {\n  if (!npm.config.get(\"rebuild-bundle\")) return cb()\n\n  var deps = Object.keys(pkg.dependencies || {})\n             .concat(Object.keys(pkg.devDependencies || {}))\n    , bundles = pkg.bundleDependencies || pkg.bundledDependencies || []\n\n  fs.readdir(path.resolve(folder, \"node_modules\"), function (er, files) {\n    // error means no bundles\n    if (er) return cb()\n\n    log.verbose(\"rebuildBundles\", files)\n    // don't asyncMap these, because otherwise build script output\n    // gets interleaved and is impossible to read\n    chain(files.filter(function (file) {\n      // rebuild if:\n      // not a .folder, like .bin or .hooks\n      return !file.match(/^[\\._-]/)\n          // not some old 0.x style bundle\n          && file.indexOf(\"@\") === -1\n          // either not a dep, or explicitly bundled\n          && (deps.indexOf(file) === -1 || bundles.indexOf(file) !== -1)\n    }).map(function (file) {\n      file = path.resolve(folder, \"node_modules\", file)\n      return function (cb) {\n        if (build._didBuild[file]) return cb()\n        log.verbose(\"rebuild bundle\", file)\n        // if file is not a package dir, then don't do it.\n        fs.lstat(path.resolve(file, \"package.json\"), function (er) {\n          if (er) return cb()\n          build_(false)(file, cb)\n        })\n    }}), cb)\n  })\n}\n\nfunction linkBins (pkg, folder, parent, gtop, cb) {\n  if (!pkg.bin || !gtop && path.basename(parent) !== \"node_modules\") {\n    return cb()\n  }\n  var binRoot = gtop ? npm.globalBin\n                     : path.resolve(parent, \".bin\")\n  log.verbose(\"link bins\", [pkg.bin, binRoot, gtop])\n\n  asyncMap(Object.keys(pkg.bin), function (b, cb) {\n    linkBin( path.resolve(folder, pkg.bin[b])\n           , path.resolve(binRoot, b)\n           , gtop && folder\n           , function (er) {\n      if (er) return cb(er)\n      // bins should always be executable.\n      // XXX skip chmod on windows?\n      var src = path.resolve(folder, pkg.bin[b])\n      fs.chmod(src, npm.modes.exec, function (er) {\n        if (er && er.code === \"ENOENT\" && npm.config.get(\"ignore-scripts\")) {\n          return cb()\n        }\n        if (er || !gtop) return cb(er)\n        var dest = path.resolve(binRoot, b)\n          , out = npm.config.get(\"parseable\")\n                ? dest + \"::\" + src + \":BINFILE\"\n                : dest + \" -> \" + src\n        console.log(out)\n        cb()\n      })\n    })\n  }, cb)\n}\n\nfunction linkBin (from, to, gently, cb) {\n  if (process.platform !== \"win32\") {\n    return linkIfExists(from, to, gently, cb)\n  } else {\n    return cmdShimIfExists(from, to, cb)\n  }\n}\n\nfunction linkMans (pkg, folder, parent, gtop, cb) {\n  if (!pkg.man || !gtop || process.platform === \"win32\") return cb()\n\n  var manRoot = path.resolve(npm.config.get(\"prefix\"), \"share\", \"man\")\n  log.verbose(\"linkMans\", \"man files are\", pkg.man, \"in\", manRoot)\n\n  // make sure that the mans are unique.\n  // otherwise, if there are dupes, it'll fail with EEXIST\n  var set = pkg.man.reduce(function (acc, man) {\n    acc[path.basename(man)] = man\n    return acc\n  }, {})\n  pkg.man = pkg.man.filter(function (man) {\n    return set[path.basename(man)] === man\n  })\n\n  asyncMap(pkg.man, function (man, cb) {\n    if (typeof man !== \"string\") return cb()\n    log.silly(\"linkMans\", \"preparing to link\", man)\n    var parseMan = man.match(/(.*\\.([0-9]+)(\\.gz)?)$/)\n    if (!parseMan) {\n      return cb(new Error(\n        man+\" is not a valid name for a man file.  \" +\n        \"Man files must end with a number, \" +\n        \"and optionally a .gz suffix if they are compressed.\"\n      ))\n    }\n\n    var stem = parseMan[1]\n    var sxn = parseMan[2]\n    var bn = path.basename(stem)\n    var manSrc = path.resolve(folder, man)\n    var manDest = path.join(manRoot, \"man\" + sxn, bn)\n\n    linkIfExists(manSrc, manDest, gtop && folder, cb)\n  }, cb)\n}\n"]}