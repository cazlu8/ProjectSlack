{"version":3,"sources":["link.js"],"names":[],"mappings":"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","file":"link-compiled.js","sourcesContent":["// link with no args: symlink the folder to the global location\n// link with package arg: symlink the global to the local\n\nvar npm = require(\"./npm.js\")\n  , symlink = require(\"./utils/link.js\")\n  , fs = require(\"graceful-fs\")\n  , log = require(\"npmlog\")\n  , asyncMap = require(\"slide\").asyncMap\n  , chain = require(\"slide\").chain\n  , path = require(\"path\")\n  , build = require(\"./build.js\")\n  , npa = require(\"npm-package-arg\")\n\nmodule.exports = link\n\nlink.usage = \"npm link (in package dir)\"\n           + \"\\nnpm link <pkg> (link global into local)\"\n\nlink.completion = function (opts, cb) {\n  var dir = npm.globalDir\n  fs.readdir(dir, function (er, files) {\n    cb(er, files.filter(function (f) {\n      return !f.match(/^[\\._-]/)\n    }))\n  })\n}\n\nfunction link (args, cb) {\n  if (process.platform === \"win32\") {\n    var semver = require(\"semver\")\n    if (!semver.satisfies(process.version, \">=0.7.9\")) {\n      var msg = \"npm link not supported on windows prior to node 0.7.9\"\n        , e = new Error(msg)\n      e.code = \"ENOTSUP\"\n      e.errno = require(\"constants\").ENOTSUP\n      return cb(e)\n    }\n  }\n\n  if (npm.config.get(\"global\")) {\n    return cb(new Error(\"link should never be --global.\\n\"\n                       +\"Please re-run this command with --local\"))\n  }\n\n  if (args.length === 1 && args[0] === \".\") args = []\n  if (args.length) return linkInstall(args, cb)\n  linkPkg(npm.prefix, cb)\n}\n\nfunction linkInstall (pkgs, cb) {\n  asyncMap(pkgs, function (pkg, cb) {\n    var t = path.resolve(npm.globalDir, \"..\")\n      , pp = path.resolve(npm.globalDir, pkg)\n      , rp = null\n      , target = path.resolve(npm.dir, pkg)\n\n    function n (er, data) {\n      if (er) return cb(er, data)\n      // install returns [ [folder, pkgId], ... ]\n      // but we definitely installed just one thing.\n      var d = data.filter(function (d) { return !d[3] })\n      var what = npa(d[0][0])\n      pp = d[0][1]\n      pkg = what.name\n      target = path.resolve(npm.dir, pkg)\n      next()\n    }\n\n    // if it's a folder, a random not-installed thing, or not a scoped package,\n    // then link or install it first\n    if (pkg[0] !== \"@\" && (pkg.indexOf(\"/\") !== -1 || pkg.indexOf(\"\\\\\") !== -1)) {\n      return fs.lstat(path.resolve(pkg), function (er, st) {\n        if (er || !st.isDirectory()) {\n          npm.commands.install(t, pkg, n)\n        } else {\n          rp = path.resolve(pkg)\n          linkPkg(rp, n)\n        }\n      })\n    }\n\n    fs.lstat(pp, function (er, st) {\n      if (er) {\n        rp = pp\n        return npm.commands.install(t, pkg, n)\n      } else if (!st.isSymbolicLink()) {\n        rp = pp\n        next()\n      } else {\n        return fs.realpath(pp, function (er, real) {\n          if (er) log.warn(\"invalid symbolic link\", pkg)\n          else rp = real\n          next()\n        })\n      }\n    })\n\n    function next () {\n      chain\n        ( [ [npm.commands, \"unbuild\", [target]]\n          , [function (cb) {\n              log.verbose(\"link\", \"symlinking %s to %s\",  pp, target)\n              cb()\n            }]\n          , [symlink, pp, target]\n          // do run lifecycle scripts - full build here.\n          , rp && [build, [target]]\n          , [ resultPrinter, pkg, pp, target, rp ] ]\n        , cb )\n    }\n  }, cb)\n}\n\nfunction linkPkg (folder, cb_) {\n  var me = folder || npm.prefix\n    , readJson = require(\"read-package-json\")\n\n  log.verbose(\"linkPkg\", folder)\n\n  readJson(path.resolve(me, \"package.json\"), function (er, d) {\n    function cb (er) {\n      return cb_(er, [[d && d._id, target, null, null]])\n    }\n    if (er) return cb(er)\n    if (!d.name) {\n      er = new Error(\"Package must have a name field to be linked\")\n      return cb(er)\n    }\n    var target = path.resolve(npm.globalDir, d.name)\n    symlink(me, target, false, true, function (er) {\n      if (er) return cb(er)\n      log.verbose(\"link\", \"build target\", target)\n      // also install missing dependencies.\n      npm.commands.install(me, [], function (er) {\n        if (er) return cb(er)\n        // build the global stuff.  Don't run *any* scripts, because\n        // install command already will have done that.\n        build([target], true, build._noLC, true, function (er) {\n          if (er) return cb(er)\n          resultPrinter(path.basename(me), me, target, cb)\n        })\n      })\n    })\n  })\n}\n\nfunction resultPrinter (pkg, src, dest, rp, cb) {\n  if (typeof cb !== \"function\") cb = rp, rp = null\n  var where = dest\n  rp = (rp || \"\").trim()\n  src = (src || \"\").trim()\n  // XXX If --json is set, then look up the data from the package.json\n  if (npm.config.get(\"parseable\")) {\n    return parseableOutput(dest, rp || src, cb)\n  }\n  if (rp === src) rp = null\n  console.log(where + \" -> \" + src + (rp ? \" -> \" + rp: \"\"))\n  cb()\n}\n\nfunction parseableOutput (dest, rp, cb) {\n  // XXX this should match ls --parseable and install --parseable\n  // look up the data from package.json, format it the same way.\n  //\n  // link is always effectively \"long\", since it doesn't help much to\n  // *just* print the target folder.\n  // However, we don't actually ever read the version number, so\n  // the second field is always blank.\n  console.log(dest + \"::\" + rp)\n  cb()\n}\n"]}