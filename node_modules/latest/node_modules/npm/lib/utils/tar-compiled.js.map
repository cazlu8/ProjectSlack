{"version":3,"sources":["tar.js"],"names":[],"mappings":"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","file":"tar-compiled.js","sourcesContent":["// commands for packing and unpacking tarballs\n// this file is used by lib/cache.js\n\nvar npm = require(\"../npm.js\")\n  , fs = require(\"graceful-fs\")\n  , writeFileAtomic = require(\"write-file-atomic\")\n  , writeStreamAtomic = require(\"fs-write-stream-atomic\")\n  , path = require(\"path\")\n  , log = require(\"npmlog\")\n  , uidNumber = require(\"uid-number\")\n  , rm = require(\"./gently-rm.js\")\n  , readJson = require(\"read-package-json\")\n  , myUid = process.getuid && process.getuid()\n  , myGid = process.getgid && process.getgid()\n  , tar = require(\"tar\")\n  , zlib = require(\"zlib\")\n  , fstream = require(\"fstream\")\n  , Packer = require(\"fstream-npm\")\n  , lifecycle = require(\"./lifecycle.js\")\n\nif (process.env.SUDO_UID && myUid === 0) {\n  if (!isNaN(process.env.SUDO_UID)) myUid = +process.env.SUDO_UID\n  if (!isNaN(process.env.SUDO_GID)) myGid = +process.env.SUDO_GID\n}\n\nexports.pack = pack\nexports.unpack = unpack\n\nfunction pack (tarball, folder, pkg, dfc, cb) {\n  log.verbose(\"tar pack\", [tarball, folder])\n  if (typeof cb !== \"function\") cb = dfc, dfc = false\n\n  log.verbose(\"tarball\", tarball)\n  log.verbose(\"folder\", folder)\n\n  if (dfc) {\n    // do fancy crap\n    return lifecycle(pkg, \"prepublish\", folder, function (er) {\n      if (er) return cb(er)\n      pack_(tarball, folder, pkg, cb)\n    })\n  } else {\n    pack_(tarball, folder, pkg, cb)\n  }\n}\n\nfunction pack_ (tarball, folder, pkg, cb) {\n  new Packer({ path: folder, type: \"Directory\", isDirectory: true })\n    .on(\"error\", function (er) {\n      if (er) log.error(\"tar pack\", \"Error reading \" + folder)\n      return cb(er)\n    })\n\n    // By default, npm includes some proprietary attributes in the\n    // package tarball.  This is sane, and allowed by the spec.\n    // However, npm *itself* excludes these from its own package,\n    // so that it can be more easily bootstrapped using old and\n    // non-compliant tar implementations.\n    .pipe(tar.Pack({ noProprietary: !npm.config.get(\"proprietary-attribs\") }))\n    .on(\"error\", function (er) {\n      if (er) log.error(\"tar.pack\", \"tar creation error\", tarball)\n      cb(er)\n    })\n    .pipe(zlib.Gzip())\n    .on(\"error\", function (er) {\n      if (er) log.error(\"tar.pack\", \"gzip error \"+tarball)\n      cb(er)\n    })\n    .pipe(writeStreamAtomic(tarball))\n    .on(\"error\", function (er) {\n      if (er) log.error(\"tar.pack\", \"Could not write \"+tarball)\n      cb(er)\n    })\n    .on(\"close\", cb)\n}\n\n\nfunction unpack (tarball, unpackTarget, dMode, fMode, uid, gid, cb) {\n  log.verbose(\"tar\", \"unpack\", tarball)\n  log.verbose(\"tar\", \"unpacking to\", unpackTarget)\n  if (typeof cb !== \"function\") cb = gid, gid = null\n  if (typeof cb !== \"function\") cb = uid, uid = null\n  if (typeof cb !== \"function\") cb = fMode, fMode = npm.modes.file\n  if (typeof cb !== \"function\") cb = dMode, dMode = npm.modes.exec\n\n  uidNumber(uid, gid, function (er, uid, gid) {\n    if (er) return cb(er)\n    unpack_(tarball, unpackTarget, dMode, fMode, uid, gid, cb)\n  })\n}\n\nfunction unpack_ ( tarball, unpackTarget, dMode, fMode, uid, gid, cb ) {\n  rm(unpackTarget, function (er) {\n    if (er) return cb(er)\n    // gzip {tarball} --decompress --stdout \\\n    //   | tar -mvxpf - --strip-components=1 -C {unpackTarget}\n    gunzTarPerm( tarball, unpackTarget\n               , dMode, fMode\n               , uid, gid\n               , function (er, folder) {\n      if (er) return cb(er)\n      readJson(path.resolve(folder, \"package.json\"), cb)\n    })\n  })\n}\n\n\nfunction gunzTarPerm (tarball, target, dMode, fMode, uid, gid, cb_) {\n  if (!dMode) dMode = npm.modes.exec\n  if (!fMode) fMode = npm.modes.file\n  log.silly(\"gunzTarPerm\", \"modes\", [dMode.toString(8), fMode.toString(8)])\n\n  var cbCalled = false\n  function cb (er) {\n    if (cbCalled) return\n    cbCalled = true\n    cb_(er, target)\n  }\n\n  var fst = fs.createReadStream(tarball)\n\n  fst.on(\"open\", function (fd) {\n    fs.fstat(fd, function (er, st) {\n      if (er) return fst.emit(\"error\", er)\n      if (st.size === 0) {\n        er = new Error(\"0-byte tarball\\n\" +\n                       \"Please run `npm cache clean`\")\n        fst.emit(\"error\", er)\n      }\n    })\n  })\n\n  // figure out who we're supposed to be, if we're not pretending\n  // to be a specific user.\n  if (npm.config.get(\"unsafe-perm\") && process.platform !== \"win32\") {\n    uid = myUid\n    gid = myGid\n  }\n\n  function extractEntry (entry) {\n    log.silly(\"gunzTarPerm\", \"extractEntry\", entry.path)\n    // never create things that are user-unreadable,\n    // or dirs that are user-un-listable. Only leads to headaches.\n    var originalMode = entry.mode = entry.mode || entry.props.mode\n    entry.mode = entry.mode | (entry.type === \"Directory\" ? dMode : fMode)\n    entry.mode = entry.mode & (~npm.modes.umask)\n    entry.props.mode = entry.mode\n    if (originalMode !== entry.mode) {\n      log.silly( \"gunzTarPerm\", \"modified mode\"\n               , [entry.path, originalMode, entry.mode])\n    }\n\n    // if there's a specific owner uid/gid that we want, then set that\n    if (process.platform !== \"win32\" &&\n        typeof uid === \"number\" &&\n        typeof gid === \"number\") {\n      entry.props.uid = entry.uid = uid\n      entry.props.gid = entry.gid = gid\n    }\n  }\n\n  var extractOpts = { type: \"Directory\", path: target, strip: 1 }\n\n  if (process.platform !== \"win32\" &&\n      typeof uid === \"number\" &&\n      typeof gid === \"number\") {\n    extractOpts.uid = uid\n    extractOpts.gid = gid\n  }\n\n  var sawIgnores = {}\n  extractOpts.filter = function () {\n    // symbolic links are not allowed in packages.\n    if (this.type.match(/^.*Link$/)) {\n      log.warn( \"excluding symbolic link\"\n              , this.path.substr(target.length + 1)\n              + \" -> \" + this.linkpath )\n      return false\n    }\n\n    // Note: This mirrors logic in the fs read operations that are\n    // employed during tarball creation, in the fstream-npm module.\n    // It is duplicated here to handle tarballs that are created\n    // using other means, such as system tar or git archive.\n    if (this.type === \"File\") {\n      var base = path.basename(this.path)\n      if (base === \".npmignore\") {\n        sawIgnores[ this.path ] = true\n      } else if (base === \".gitignore\") {\n        var npmignore = this.path.replace(/\\.gitignore$/, \".npmignore\")\n        if (sawIgnores[npmignore]) {\n          // Skip this one, already seen.\n          return false\n        } else {\n          // Rename, may be clobbered later.\n          this.path = npmignore\n          this._path = npmignore\n        }\n      }\n    }\n\n    return true\n  }\n\n\n  fst\n    .on(\"error\", function (er) {\n      if (er) log.error(\"tar.unpack\", \"error reading \"+tarball)\n      cb(er)\n    })\n    .on(\"data\", function OD (c) {\n      // detect what it is.\n      // Then, depending on that, we'll figure out whether it's\n      // a single-file module, gzipped tarball, or naked tarball.\n      // gzipped files all start with 1f8b08\n      if (c[0] === 0x1F &&\n          c[1] === 0x8B &&\n          c[2] === 0x08) {\n        fst\n          .pipe(zlib.Unzip())\n          .on(\"error\", function (er) {\n            if (er) log.error(\"tar.unpack\", \"unzip error \"+tarball)\n            cb(er)\n          })\n          .pipe(tar.Extract(extractOpts))\n          .on(\"entry\", extractEntry)\n          .on(\"error\", function (er) {\n            if (er) log.error(\"tar.unpack\", \"untar error \"+tarball)\n            cb(er)\n          })\n          .on(\"close\", cb)\n      } else if (hasTarHeader(c)) {\n        // naked tar\n        fst\n          .pipe(tar.Extract(extractOpts))\n          .on(\"entry\", extractEntry)\n          .on(\"error\", function (er) {\n            if (er) log.error(\"tar.unpack\", \"untar error \"+tarball)\n            cb(er)\n          })\n          .on(\"close\", cb)\n      } else {\n        // naked js file\n        var jsOpts = { path: path.resolve(target, \"index.js\") }\n\n        if (process.platform !== \"win32\" &&\n            typeof uid === \"number\" &&\n            typeof gid === \"number\") {\n          jsOpts.uid = uid\n          jsOpts.gid = gid\n        }\n\n        fst\n          .pipe(fstream.Writer(jsOpts))\n          .on(\"error\", function (er) {\n            if (er) log.error(\"tar.unpack\", \"copy error \"+tarball)\n            cb(er)\n          })\n          .on(\"close\", function () {\n            var j = path.resolve(target, \"package.json\")\n            readJson(j, function (er, d) {\n              if (er) {\n                log.error(\"not a package\", tarball)\n                return cb(er)\n              }\n              writeFileAtomic(j, JSON.stringify(d) + \"\\n\", cb)\n            })\n          })\n      }\n\n      // now un-hook, and re-emit the chunk\n      fst.removeListener(\"data\", OD)\n      fst.emit(\"data\", c)\n    })\n}\n\nfunction hasTarHeader (c) {\n  return c[257] === 0x75 && // tar archives have 7573746172 at position\n         c[258] === 0x73 && // 257 and 003030 or 202000 at position 262\n         c[259] === 0x74 &&\n         c[260] === 0x61 &&\n         c[261] === 0x72 &&\n\n       ((c[262] === 0x00 &&\n         c[263] === 0x30 &&\n         c[264] === 0x30) ||\n\n        (c[262] === 0x20 &&\n         c[263] === 0x20 &&\n         c[264] === 0x00))\n}\n"]}