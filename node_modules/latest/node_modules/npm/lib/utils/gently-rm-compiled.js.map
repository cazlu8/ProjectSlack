{"version":3,"sources":["gently-rm.js"],"names":[],"mappings":"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","file":"gently-rm-compiled.js","sourcesContent":["// only remove the thing if it's a symlink into a specific folder.\n// This is a very common use-case of npm's, but not so common elsewhere.\n\nmodule.exports = gentlyRm\n\nvar npm = require('../npm.js')\nvar log = require('npmlog')\nvar resolve = require('path').resolve\nvar dirname = require('path').dirname\nvar lstat = require('graceful-fs').lstat\nvar readlink = require('graceful-fs').readlink\nvar isInside = require('path-is-inside')\nvar vacuum = require('fs-vacuum')\nvar some = require('async-some')\nvar asyncMap = require('slide').asyncMap\nvar normalize = require('path').normalize\n\nfunction gentlyRm (target, gently, base, cb) {\n  if (!cb) {\n    cb = base\n    base = undefined\n  }\n\n  if (!cb) {\n    cb = gently\n    gently = false\n  }\n\n  log.silly(\n    'gentlyRm',\n    target,\n    'is being', gently ? 'gently removed' : 'purged',\n    base ? 'from base ' + base : ''\n  )\n\n  // never rm the root, prefix, or bin dirs\n  //\n  // globals included because of `npm link` -- as far as the package requesting\n  // the link is concerned, the linked package is always installed globally\n  var prefixes = [\n    npm.prefix,\n    npm.globalPrefix,\n    npm.dir,\n    npm.root,\n    npm.globalDir,\n    npm.bin,\n    npm.globalBin\n  ]\n\n  var resolved = normalize(resolve(npm.prefix, target))\n  if (prefixes.indexOf(resolved) !== -1) {\n    log.verbose('gentlyRm', resolved, \"is part of npm and can't be removed\")\n    return cb(new Error('May not delete: ' + resolved))\n  }\n\n  var options = { log: log.silly.bind(log, 'vacuum-fs') }\n  if (npm.config.get('force') || !gently) options.purge = true\n  if (base) options.base = normalize(resolve(npm.prefix, base))\n\n  if (!gently) {\n    log.verbose('gentlyRm', \"don't care about contents; nuking\", resolved)\n    return vacuum(resolved, options, cb)\n  }\n\n  var parent = options.base = normalize(base ? resolve(npm.prefix, base) : npm.prefix)\n\n  // is the parent directory managed by npm?\n  log.silly('gentlyRm', 'verifying', parent, 'is an npm working directory')\n  some(prefixes, isManaged(parent), function (er, matched) {\n    if (er) return cb(er)\n\n    if (!matched) {\n      log.error('gentlyRm', 'containing path', parent, \"isn't under npm's control\")\n      return clobberFail(resolved, parent, cb)\n    }\n    log.silly('gentlyRm', 'containing path', parent, \"is under npm's control, in\", matched)\n\n    // is the target directly contained within the (now known to be\n    // managed) parent?\n    if (isInside(resolved, parent)) {\n      log.silly('gentlyRm', 'deletion target', resolved, 'is under', parent)\n      log.verbose('gentlyRm', 'vacuuming from', resolved, 'up to', parent)\n      return vacuum(resolved, options, cb)\n    }\n    log.silly('gentlyRm', resolved, 'is not under', parent)\n\n    // the target isn't directly within the parent, but is it itself managed?\n    log.silly('gentlyRm', 'verifying', resolved, 'is an npm working directory')\n    some(prefixes, isManaged(resolved), function (er, matched) {\n      if (er) return cb(er)\n\n      if (matched) {\n        log.silly('gentlyRm', resolved, \"is under npm's control, in\", matched)\n        options.base = matched\n        log.verbose('gentlyRm', 'removing', resolved, 'with base', options.base)\n        return vacuum(resolved, options, cb)\n      }\n      log.verbose('gentlyRm', resolved, \"is not under npm's control\")\n\n      // the target isn't managed directly, but maybe it's a link...\n      log.silly('gentlyRm', 'checking to see if', resolved, 'is a link')\n      lstat(resolved, function (er, stat) {\n        if (er) {\n          // race conditions are common when unbuilding\n          if (er.code === 'ENOENT') return cb(null)\n          return cb(er)\n        }\n\n        if (!stat.isSymbolicLink()) {\n          log.error('gentlyRm', resolved, 'is outside', parent, 'and not a link')\n          return clobberFail(resolved, parent, cb)\n        }\n\n        // ...and maybe the link source, when read...\n        log.silly('gentlyRm', resolved, 'is a link')\n        readlink(resolved, function (er, link) {\n          if (er) {\n            // race conditions are common when unbuilding\n            if (er.code === 'ENOENT') return cb(null)\n            return cb(er)\n          }\n\n          // ...is inside the managed parent\n          var source = resolve(dirname(resolved), link)\n          if (isInside(source, parent)) {\n            log.silly('gentlyRm', source, 'symlink target', resolved, 'is inside', parent)\n            log.verbose('gentlyRm', 'vacuuming', resolved)\n            return vacuum(resolved, options, cb)\n          }\n\n          log.error('gentlyRm', source, 'symlink target', resolved, 'is not controlled by npm', parent)\n          return clobberFail(target, parent, cb)\n        })\n      })\n    })\n  })\n}\n\nvar resolvedPaths = {}\nfunction isManaged (target) {\n  return function predicate (path, cb) {\n    if (!path) {\n      log.verbose('isManaged', 'no path passed for target', target)\n      return cb(null, false)\n    }\n\n    asyncMap([path, target], resolveSymlink, function (er, results) {\n      if (er) {\n        if (er.code === 'ENOENT') return cb(null, false)\n\n        return cb(er)\n      }\n\n      var path = results[0]\n      var target = results[1]\n      var inside = isInside(target, path)\n      if (!inside) log.silly('isManaged', target, 'is not inside', path)\n\n      return cb(null, inside && path)\n    })\n  }\n\n  function resolveSymlink (toResolve, cb) {\n    var resolved = resolve(npm.prefix, toResolve)\n\n    // if the path has already been memoized, return immediately\n    var cached = resolvedPaths[resolved]\n    if (cached) return cb(null, cached)\n\n    // otherwise, check the path\n    lstat(resolved, function (er, stat) {\n      if (er) return cb(er)\n\n      // if it's not a link, cache & return the path itself\n      if (!stat.isSymbolicLink()) {\n        resolvedPaths[resolved] = resolved\n        return cb(null, resolved)\n      }\n\n      // otherwise, cache & return the link's source\n      readlink(resolved, function (er, source) {\n        if (er) return cb(er)\n\n        resolved = resolve(resolved, source)\n        resolvedPaths[resolved] = resolved\n        cb(null, resolved)\n      })\n    })\n  }\n}\n\nfunction clobberFail (target, root, cb) {\n  var er = new Error('Refusing to delete: ' + target + ' not in ' + root)\n  er.code = 'EEXIST'\n  er.path = target\n  return cb(er)\n}\n"]}